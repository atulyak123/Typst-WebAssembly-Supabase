<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Typst Playground</title>
    <!-- global styles (login + playground + dashboard) -->
    <link rel="stylesheet" href="/src/style.css" />
    <!-- Typst WASM bundle (unchanged) -->
    <script type="module" crossorigin
      src="https://cdn.jsdelivr.net/npm/@myriaddreamin/typst-all-in-one.ts@0.6.1-rc1/dist/esm/index.js"
      id="typst"></script>
  </head>
  <body>
    <!-- single mount point -->
    <div id="root"></div>

    <!-- enhanced router with dashboard -->
 <script type="module">
  import { getSession, onSession } from "/src/auth/auth.ts";
  import { mountLogin } from "/src/auth/login.ts";
  import { mountDashboard } from "/src/dashboard/dashboard.ts";
  import { supabase } from "/src/lib/superbaseClient";  // ‚Üê Fixed: removed .ts
  import { loadProjectFile, saveProjectFile } from "/src/lib/projectService";  // ‚Üê Fixed: removed .ts
  
  const root = document.getElementById("root");

  // Define base path to match Vite config
  const BASE_PATH = "/Typst-WebAssembly";

  /* ---------- Router Functions ---------- */
  function getCurrentPath() {
    const fullPath = window.location.pathname;
    // Remove base path to get the app route
    if (fullPath.startsWith(BASE_PATH)) {
      return fullPath.substring(BASE_PATH.length) || '/';
    }
    return fullPath;
  }

  function getFullPath(appPath) {
    // Add base path for navigation
    if (appPath === '/') {
      return BASE_PATH + '/';
    }
    return BASE_PATH + appPath;
  }

  function isEditorPath() {
    return getCurrentPath().startsWith('/editor');
  }

  function getProjectIdFromPath() {
    const path = getCurrentPath();
    const match = path.match(/^\/editor\/(.+)$/);
    return match ? match[1] : null;
  }

  async function loadProjectData(projectId) {
    try {
      console.log('Loading project data for:', projectId);
      
      const { data: row, error } = await supabase
        .from("projects")
        .select("title, typ_path")
        .eq("id", projectId)
        .single();

      if (error) {
        console.error('Database error:', error);
        throw error;
      }

      // show title in toolbar
      const titleElement = document.getElementById("project-title");
      if (titleElement) {
        titleElement.textContent = row.title;
      }

      let code = "";
      try {
        code = await loadProjectFile(row.typ_path);
        console.log('File loaded successfully');
      } catch (e) {
        console.log('File load error:', e);
        if (e?.status !== 404) throw e; // re-throw real errors
        // If file doesn't exist, code stays empty string
      }

      // expose to editor
      window.__initialDoc = code;
      window.__currentProjectId = projectId;
      window.__currentTypPath = row.typ_path;
      
      console.log('Project data loaded successfully');
    } catch (error) {
      console.error('Error in loadProjectData:', error);
      // Set fallback values
      window.__initialDoc = '';
      window.__currentProjectId = projectId;
      window.__currentTypPath = null;
    }
  }

  /* ---------- Enhanced Editor Mounting ---------- */
  async function mountEditor(projectId = null) {
    console.log('Mounting editor for project:', projectId);
    
    root.innerHTML = `
      <header id="toolbar">
        <div class="toolbar-left">
          <button id="back-btn" class="back-btn" title="Back to Dashboard">
            ‚Üê Dashboard
          </button>
          <span id="project-title" class="project-title">
            ${projectId ? 'Loading project...' : 'New Document'}
          </span>
        </div>
        <div class="toolbar-right">
          <span id="user-email" class="user-email">Loading...</span>
          <button id="theme-btn" aria-label="toggle theme">üåô</button>
          <button id="export-btn" aria-label="Download">‚¨áÔ∏è</button>
          <button id="save-btn" aria-label="Save" class="save-btn" style="display: ${projectId ? 'block' : 'none'}">üíæ</button>
          <button id="logout-btn" aria-label="Sign out" class="logout-btn">Logout</button>
        </div>
      </header>
      <div id="app">
        <div id="editor"></div>
        <div id="preview"></div>
      </div>
    `;

    // Setup navigation
    setupEditorNavigation();
    
    // Load user info
    await loadUserInfoInEditor();
    
    // Load project data if projectId exists
    if (projectId) {
      await loadProjectData(projectId);
    } else {
      // Set default content for new documents
      window.__initialDoc = `= New Document

Welcome to Typst!

Start typing here...`;
      window.__currentProjectId = null;
      window.__currentTypPath = null;
    }

    // Import and initialize editor
    console.log('Importing editor module...');
    try {
      await import("/src/editor/main.ts");
      console.log('Editor module imported successfully');
    } catch (error) {
      console.error('Failed to import editor:', error);
    }
  }

  function setupEditorNavigation() {
    // Back to dashboard button
    const backBtn = document.getElementById("back-btn");
    backBtn?.addEventListener("click", () => {
      navigateTo('/dashboard');
    });

    // Logout functionality
    const logoutBtn = document.getElementById("logout-btn");
    logoutBtn?.addEventListener("click", async () => {
      if (confirm("Are you sure you want to sign out?")) {
        try {
          const { signOut } = await import("/src/auth/auth.ts");
          await signOut();
        } catch (error) {
          console.error("Logout failed:", error);
        }
      }
    });

    // Save functionality
    const saveBtn = document.getElementById("save-btn");
saveBtn?.addEventListener("click", async () => {
  try {
    const typPath = window.__currentTypPath;
    const projectId = window.__currentProjectId;
    const code = window.__editorView?.state?.doc?.toString() ?? "";

    if (!code.trim()) {
      alert("No content to save");
      return;
    }

    await saveProjectFile(projectId, typPath, code);
    alert("Saved!");
  } catch (e) {
    console.error(e);
    alert("Save failed: " + e.message);
  }
});

  }

  async function loadUserInfoInEditor() {
    try {
      const { getCurrentUser } = await import("/src/auth/auth.ts");
      const user = await getCurrentUser();
      
      const userEmailElement = document.getElementById("user-email");
      if (user && userEmailElement) {
        userEmailElement.textContent = user.email?.split('@')[0] || 'User';
      }
    } catch (error) {
      console.error('Failed to load user info:', error);
    }
  }

  /* ---------- Navigation Helper ---------- */
  function navigateTo(appPath) {
    const fullPath = getFullPath(appPath);
    window.history.pushState({}, '', fullPath);
    handleRoute();
  }

  /* ---------- Route Handler ---------- */
  function handleRoute() {
    const path = getCurrentPath();
    console.log('Handling route:', path);
    
    if (path === '/' || path === '/dashboard') {
      mountDashboard(root);
    } else if (path.startsWith('/editor')) {
      const projectId = getProjectIdFromPath();
      mountEditor(projectId);
    } else {
      // Default to dashboard
      navigateTo('/dashboard');
    }
  }

  /* ---------- Browser Navigation ---------- */
  window.addEventListener('popstate', () => {
    handleRoute();
  });

  /* ---------- Initial Auth Gate ---------- */
  getSession().then(({ data }) => {
    if (data.session) {
      // User is logged in, route them appropriately
      if (isEditorPath()) {
        const projectId = getProjectIdFromPath();
        mountEditor(projectId);
      } else {
        // Default to dashboard
        navigateTo('/dashboard');
      }
    } else {
      // User not logged in, show login page
      mountLogin(root);
    }
  });

  /* ---------- Auth State Changes ---------- */
  onSession(user => {
    if (user) {
      // User just logged in, go to dashboard
      navigateTo('/dashboard');
    } else {
      // User logged out, show login
      mountLogin(root);
    }
  });

  /* ---------- Global Navigation Functions (for dashboard) ---------- */
  window.navigateToEditor = function(projectId = null) {
    const path = projectId ? `/editor/${projectId}` : '/editor';
    navigateTo(path);
  };

  window.navigateToDashboard = function() {
    navigateTo('/dashboard');
  };

  /* ---------- Initial Route Handling ---------- */
  // Handle the initial load
  document.addEventListener('DOMContentLoaded', () => {
    // If user visits the base path directly, redirect to app
    if (window.location.pathname === BASE_PATH || window.location.pathname === BASE_PATH + '/') {
      const currentPath = getCurrentPath();
      if (currentPath === '/') {
 
        handleRoute();
      }
    }
  });
</script>
  </body>
</html>